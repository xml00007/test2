{"version":3,"sources":["../../selenium/mofengwo.js"],"names":["fetch","require","fs","cheerio","debug","htmlparser2","restClient","option","url","getData","payload","requestAsync","mddid","page","sort","getDataNew","i","newPayload","JSON","parse","stringify","data","list","msg","dom","parseDOM","$","load","map","obj","find","attr","title","split","slice","join","filteremoji","moFengWo","create","ss","regStr","replace","loadPage","http","pm","Promise","resolve","reject","get","res","html","on","d","toString","e","getOtherData","urls","findAll","where","startDate","cost","order","limit","attributes","m","length","realurl","dataValues","update","then","children","next","outDays","renWu","err","console","log","j","processData","setTimeout","exportData","datas","newdata","item","it","Object","keys","forEach","o","push"],"mappings":"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","file":"mofengwo.js","sourcesContent":["const fetch = require('node-fetch');\nimport Model from '../sequelize';\nimport RestClient from '../restClient';\n\nconst fs = require('fs');\nlet cheerio = require('cheerio');\nconst debug = require('nirvana-logger')('result');\nconst htmlparser2 = require('htmlparser2');\nconst restClient = new RestClient();\nlet option = {\n    'path': '',\n    'method': 'POST',\n    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',\n    'timeout': 2 * 60 * 1000, // 超时时间 2分钟\n};\n\nconst url = 'http://www.mafengwo.cn/gonglve/ajax.php?act=get_travellist';\n\nasync function getData(payload) {\n    return await restClient.requestAsync(url, option, {payload});\n}\n\n\n// for (let i = 1; i < 201; i++) {\n//     option.body = 'mddid=10183&pageid=' + i;\n//     const newOption = JSON.parse(JSON.stringify(option));\n//     getData(url, newOption).then(function (data) {\n//         // 解析数据\n//         // console.log('data', data);\n//         if (data.msg === 'succ') {\n//             console.log('data.list.length', data.list.length);\n//             const dom = htmlparser2.parseDOM(data.list);\n//             let $ = cheerio.load(dom);\n//             console.log('length', $('.post-item').length);\n//             $('.post-item').map(function () {\n//                 let obj = {};\n//                 obj.url = $(this).find('.post-cover a').attr('href');\n//                 obj.title = $(this).find('.post-cover img').attr('alt').split('_').slice(0, -1).join('') // 过滤表情符号\n//                     .replace(/\\uD83C[\\uDF00-\\uDFFF]|\\uD83D[\\uDC00-\\uDE4F]/g, 'BQ');\n//                 Model.moFengWo.create(obj)\n//                     .then(function (data) {\n//                     })\n//                     .catch(function (err) {\n//                         Model.errorLog.create({message: obj.url});\n//                         console.log('rithtData', filteremoji(obj.title));\n//                         // Model.errorLog.create({message: filteremoji(obj.title)});\n//                     });\n//             });\n//         }\n//     }).catch(function (err) {\n//         debug('err', err);\n//     });\n// }\n// let i = 201;\nlet payload = {\n    mddid: 10183,\n    page: 1,\n    sort: 2\n};\n\nasync function getDataNew(i) {\n    payload.page = i;\n    debug(`当前第${i}页的数据`);\n    const newPayload = JSON.parse(JSON.stringify(payload));\n    debug(`newPayload`, newPayload);\n    const data = await getData(newPayload);\n    debug('data.list', data.list);\n    if (data.msg === 'succ') {\n        const dom = htmlparser2.parseDOM(data.list);\n        let $ = cheerio.load(dom);\n        $('.post-item').map(function() {\n            let obj = {};\n            obj.url = $(this).find('.post-cover a').attr('href');\n            obj.title = $(this).find('.post-cover img').attr('alt').split('_').slice(0, -1).join(''); // 过滤表情符号\n            obj.title = filteremoji(obj.title);// 过滤表情符号\n            debug(obj.title);\n            Model.moFengWo.create(obj);\n        });\n    }\n    if (i <= 1185) {\n        i += 1;\n        getDataNew(i);\n    }\n}\n\n\n// 获取标题和url\nasync function ss() {\n    await getDataNew(202);\n}\n\n// ss();\n\n\n//  过滤表情字符\nfunction filteremoji(data) {\n    let regStr = /[\\uD83C|\\uD83D|\\uD83E][\\uDC00-\\uDFFF][\\u200D|\\uFE0F]|[\\uD83C|\\uD83D|\\uD83E][\\uDC00-\\uDFFF]|[0-9|*|#]\\uFE0F\\u20E3|[0-9|#]\\u20E3|[\\u203C-\\u3299]\\uFE0F\\u200D|[\\u203C-\\u3299]\\uFE0F|[\\u2122-\\u2B55]|\\u303D|[\\A9|\\AE]\\u3030|\\uA9|\\uAE|\\u3030/ig;\n    return data.replace(regStr, 'BQ');\n}\n\nfunction loadPage(url) {\n    let http = require('http');\n    let pm = new Promise(function(resolve, reject) {\n        http.get(url, function(res) {\n            let html = '';\n            res.on('data', function(d) {\n                html += d.toString();\n            });\n            res.on('end', function() {\n                resolve(html);\n            });\n        }).on('error', function(e) {\n            reject(e);\n        });\n    });\n    return pm;\n}\n\n\nasync function getOtherData() {\n    const urls = await Model.moFengWo.findAll({\n        where: {startDate: '', cost: '1111'}, // url: {$like: '/i/7%'},\n        order: ['url'],\n        limit: 1000,\n        attributes: ['url']\n    });\n    for (let m = 0; m < urls.length; m++) {\n        let realurl = urls[m].dataValues.url;\n        try {\n            debug('realUrl', realurl);\n            const update = await loadPage('http://www.mafengwo.cn' + realurl).then(function(data) {\n                const dom = htmlparser2.parseDOM(data);\n                let $ = cheerio.load(dom);\n                let obj = {};\n                if (!$('body').html()) {\n                    return null;\n                }\n                // console.log('html', $('body').html());\n                // console.log('html', $('.tarvel_dir_list .cost').children().length);\n                obj.startDate = $('.tarvel_dir_list .time').children().length > 0 ? $('.tarvel_dir_list .time').children()['0'].next.data : '';\n                obj.outDays = $('.tarvel_dir_list .day').children().length > 0 ? $('.tarvel_dir_list .day').children()['0'].next.data : '';\n                obj.renWu = $('.tarvel_dir_list .people').children().length > 0 ? $('.tarvel_dir_list .people').children()['0'].next.data : '';\n                obj.cost = $('.tarvel_dir_list .cost').children().length > 0 ? $('.tarvel_dir_list .cost').children()['0'].next.data : '2222';\n                return obj;\n            });\n\n            if (!update) {\n                break;\n            }\n            debug('update', update);\n            await Model.moFengWo.update(update, {where: {url: realurl}});\n        } catch (err) {\n            console.log('realurl', realurl, err);\n        }\n    }\n    debug('done');\n}\n\nlet j = 1;\n\nfunction processData() {\n    debug(`当前第${j}次`);\n    j++;\n    setTimeout(getOtherData, 1000);\n}\n\n// processData();\n// setInterval(processData, 3*60*1000);\n\n// getOtherData('http://www.mafengwo.cn/i/8100970.html');\n\n// loadPage('http://www.mafengwo.cn/i/3279103.html').then(function(data) {\n//     console.log('data', data);\n// }).catch(function(err) {\n//     console.log('err', err);\n// });\n\nimport {writeXls} from '../excel';\n\nasync function exportData() {\n    const datas = await Model.moFengWo.findAll({\n        attributes: ['title', 'startDate', 'outDays', 'renWu', 'cost'],\n        order: [['startDate', 'DESC']]\n        // limit: 10\n    });\n    const newdata = datas.map((item) => {\n        let obj = [];\n        const it = item.dataValues;\n        Object.keys(it).forEach((o) => obj.push(it[o]));\n        return obj;\n    });\n    console.log(newdata);\n    writeXls(newdata, 'data', 'mafengwo');\n}\n\nexportData();\n\n\n"]}